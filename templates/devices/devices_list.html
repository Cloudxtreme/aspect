{% extends "index.html" %}

{% block script %}
<script type="text/javascript">
    $(document).ready(function(){

        function start_scanner(net_id)  
        {
            $.getJSON( "{% url 'run_ipscanner' %}", {id:net_id} ,function(data) {
                    if (data.done){
                        var options = 'Сканирование завершено';
                        $('.progress-bar').html(options); 
                        $('.progress-bar').removeClass('active');
                    }
                    for (var i = 0; i < data.unknown_list.length; i++) {
                        html = '<li><a href="http://'+ data.unknown_list[i] +'">' + data.unknown_list[i] + '</li>'
                        $('#unknown').html(html);
                        }
                });
        };

        function get_counter()  
        {
            $.getJSON( "{% url 'get_ipscanner_state' %}" ,function(data) {
                    var counter = data.counter
                    var options = counter + ' %'
                    var bar = $('.progress-bar');
                    bar.attr('aria-valuenow',counter)
                    bar.html(options)
                    bar.width(counter+'%');
                    if (counter!="100"){
                        window.setTimeout( get_counter, 1000 );
                    }
                }); 
        };        
        
        $("#reload").click(function() {
                        location.reload();
                    });
        $("#scan").click(function() {
                        $(this).hide();
                        start_scanner($('.active').attr('id'));
                        $('#progress').show();
                        window.setTimeout( get_counter, 2000 );
                    });
    }); 
</script>
{% endblock %}

{% block main %} 

<div class="page-header">
    <h2 class="sub-header">Оборудование по подсетям</h2>
    <a href="{% url 'device_edit' 0 %}">Добавить новое устройство
    <span class="glyphicon glyphicon-plus-sign"></span></a>
</div>
<div class="row">
    <div class="col-md-3">
        <ul class="nav nav-pills nav-stacked">
            <li><a href="{% url 'devices_list' 1 %}">Без адреса</a></li>
            {% for item in parent_nets %}
                {% url 'devices_list' item.id as target_url %}
                <li {% if request.META.PATH_INFO ==  target_url%} class="active" id='{{item.id}}'{% endif %}>
                    <a href="{{ target_url }}">{{ item }}</a>
                </li>
            {% endfor %}
        </ul>
    </div>
    <div class="col-md-9">
        <h4 class="sub-header">
            <a id="scan" href="#">Сканировать подсеть</a>
        </h4>
        <div class="alert alert-info alert-dismissible fade in" role="alert" id="progress" hidden='true'>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <div class="progress" >
                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
                    0 %
                </div>
            </div>            
            <ul id='unknown'>
            </ul>
            <ul id='created'>
            </ul>
        </div>
        <div class="list-group">
            {% for device in dev_list %}
            <a href="{% url 'device_view' device.pk %}" class="list-group-item">
            <h4 class="list-group-item-heading">{{ device.ip.ip }} - {{ device.devtype }}</h4>
            <p class="list-group-item-text">{{ device.comment|safe }}</p>
            <p class="list-group-item-text">{{ device.location|default_if_none:"<span class='label label-danger'>Местоположение не указано</span>" }}</p>
            </a>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}